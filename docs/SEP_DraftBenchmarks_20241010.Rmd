---
title: "DraftBenchmarks_SEP_20241010"
author: "Tor Kitching"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
# knitr::opts_chunk$set(echo = TRUE)
```

```{r libraries, echo=FALSE, message=FALSE, warning=FALSE}
library(RTMB)
library(ggplot2)
library(dplyr)
library(tidyverse)
library(progress)
library(diffr)
library(knitr)
```

```{r custom library, echo=FALSE, warning=FALSE, message=FALSE}
source(here::here("R/helperFunctions.R"))
source(here::here("R/PlotFunctions.R"))
source(here::here("R/IWAM_model.R"))
```

# Document Objectives

The purpose of this document is to provide "DRAFT" stock-assessment reference points to the SEP team for back-calculated watershed areas. All code will be drawn from the IWAM function vignette. The following document is originally sourced from the IWAM repository. A new version has been made to reflect major updates to the model languages used.

## S1. Data Map

The following function vignette/example is from the IWAM Package Repo hosted publicly through the Pacific Salmon Assess organization available at [this link.](https://github.com/Pacific-salmon-assess/iwam-package)

The package currently utilizes the following data sets:

-   *SRinputfile (Private)*: Private data-sets developed by Parken et al. (2006). Required to run the complete function and is available upon request. To be updated with publicly available data. Life histories are included: 1 = ocean type, 0 = stream type. Contains stock names, year, spawners, recruits, and life history identification. 
-   *WatershedArea (Public)*: Internal input containing watershed areas per stock.
-   *CUPars_nBC (Public)*: Input file with Ricker $\alpha$'s without bias correction (CITATION) from Diana Dobson's Run Reconstruction coded in TMB. Has a higher estimate of Ricker $\alpha$ (lower Sgen).
-   *CUPars_wBC (Public)*: Input file with Ricker $\alpha$'s with bias correction (CITATION) from Diana Dobson's Run Reconstruction coded in TMB. Has a higher estimate of Ricker $\alpha$ (lower Sgen).
-   *Backcalc_targetstocks (Public)*: Back-calculated user watershed area input file. Watershed areas calculated based on Parken estimates of SMSY and SREP. All aggregate information; CU, and Inlet, have been removed. PLEASE NOTE: All WCVI stocks use watershed areas with input from WCVI Staff: Nahmint, Sarita, Somass, Bedwell/Ursus, Cypre, Megin, Moyeha, Tranquil, Artlish, Kaouk, Tahsish, Nitinat, Burman, Conuma, Gold, Leiner, Tahsis, Zeballos, Cayeghle, Marble, San Juan,	Canton Creek, Espinosa, Kauwinch River, Kleeptee, Little Zeballos River, Malksope River, McKay Cove Creek, Mooyah River, Ououkinsh River, Sucwoa River, Tlupana River, Tsowwin River. PLEASE NOTE: duplicate stock/river names are no acceptable for example in the case of Seymour river - please specify their difference - Georgia Strait vs. South Thompson origins in the river name itself. Duplicate river names will result in a invalid object lengths error when running the IWAM function.

## S2. IWAM Model Function

```{r test, include=FALSE}
# here::here()
# getwd()
```

```{r iwam function, echo=TRUE, message=FALSE, warning=FALSE, results=FALSE}
iwam_default <- IWAM_func(WAinraw = c("DataIn/Ordered_backcalculated_noagg.csv"), # Input data (INPUT File)
                          # Default: "DataIn/WCVIStocks_NoAgg.csv"
                          targetname = "Draft", # Naming convention for output files
                          # remove.EnhStocks = FALSE, # Remove enhancement stocks (INPUT choice)
                          predict.syn = TRUE, # Run predictions
                          predict.tar = TRUE, # Run bootstrapping function
                          bs_nBS = 20000, # Bootstrapping iterations
                          bs_seed = 1, # Bootstrap seed 
                          plot = FALSE, # Produce plotted files for SR curves, etc.
                          SigRicPrior = c(F,T,F), # Ricker penalty term selection
                          SigDeltaPrior = c(F,T,F), # WA Regression penalty term selection
                          TauPrior = c(0.1, 1)) # Tau penalty term selection for inv gamma distribution
```

## S3. Model Outputs

```{r benchmarks table, echo=FALSE, message=FALSE, warning=FALSE}
# Table of SGEN, SMSY, and SREP for target WCVI ####

# Prepare Data 
SREP <- iwam_default$dfout %>%
  filter(RP=='SREP') %>%
  rename('Lower Quantile'=lwr, 'SREP'=Value, 'Upper Quantile'=upr) %>%
  mutate(RP = NULL) %>%
  relocate(Stock)
SMSY <- iwam_default$dfout %>%
  filter(RP=='SMSY') %>%
  rename('Lower Quantile'=lwr, 'SMSY'=Value, 'Upper Quantile'=upr) %>%
  mutate(RP = NULL) %>%
  relocate(Stock)
SGEN <- iwam_default$dfout %>%
  filter(RP=='SGEN') %>%
  rename('Lower Quantile'=lwr, 'SGEN'=Value, 'Upper Quantile'=upr) %>%
  mutate(RP = NULL) %>%
  relocate(Stock)

complete <- data.frame(SGEN, SREP, SMSY) %>%
  # confirm that all stocks line-up
  select(-Stock.1, -Stock.2, -WA.1, -WA.2, -lh.1, -lh.2) %>%
  rename("SGEN LQ" = Lower.Quantile, "SGEN UQ" = Upper.Quantile, "SREP LQ" = Lower.Quantile.1, "SREP UQ" = Upper.Quantile.1,
         "SMSY LQ" = Lower.Quantile.2, "SMSY UQ" = Upper.Quantile.2, "LH" = lh)

complete <- complete %>%
  relocate(WA, .after=Stock) %>%
  relocate(LH, .after=WA) %>% 
  mutate_at(vars(SGEN, "SGEN LQ", "SGEN UQ", SMSY, "SMSY UQ", "SMSY LQ",
                 SREP, "SREP LQ", "SREP UQ"), round, 0)

# kable table
kable(complete, caption = "IWAM Smax Model: SGEN, SREP, and SMSY Estimates for All Stocks",
      format.args = list(big.mark = ","))

write.csv(complete, here::here("Reports/TableofEstimates_kable_SEPdraftbenchmarks.csv"), row.names = FALSE)
```

